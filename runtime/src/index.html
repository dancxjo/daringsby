<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Pete Interface</title>
<style>
body { font-family: sans-serif; margin:0; padding:0; }
#main { display:flex; gap:1rem; padding:1rem; }
#left { flex:3; }
#right { flex:1; }
pre { background:#000; color:#0f0; padding:0.5rem; height:150px; overflow-y:auto; }
canvas { width:100%; height:60px; border:1px solid #ccc; }
</style>
</head>
<body>
<p>Hello Pete. Treat these inputs as your own organs. Narrate them in first person.</p>
<div id="main">
  <div id="left">
    <input id="text" type="text" placeholder="Type to Pete" />
    <button id="send">Send</button>
    <button id="record">Record</button>
    <label><input type="checkbox" id="mute"/>Mute</label>
    <canvas id="osc"></canvas>
    <pre id="history"></pre>
    <pre id="thoughts"></pre>
  </div>
  <div id="right">
    <iframe id="face" src="/face" style="border:none;width:100%;height:150px"></iframe>
    <div id="location"></div>
  </div>
</div>
<script>
const ws = new WebSocket(`ws://${location.host}/ws`);
const textEl = document.getElementById('text');
document.getElementById('send').onclick = () => {
  ws.send(JSON.stringify({type:'text', value:textEl.value}));
  textEl.value='';
};
ws.onmessage = ev => {
  const m = JSON.parse(ev.data);
  if(m.kind==='say') append('history', m.content);
  if(m.kind==='think') append('thoughts', m.content);
};
function append(id, msg){
  const pre = document.getElementById(id);
  const atBottom = pre.scrollTop + pre.clientHeight >= pre.scrollHeight - 5;
  pre.textContent += msg + '\n';
  if(atBottom) pre.scrollTop = pre.scrollHeight;
}
navigator.geolocation.getCurrentPosition(pos=>{
  document.getElementById('location').textContent =
    `Location: ${pos.coords.latitude.toFixed(4)}, ${pos.coords.longitude.toFixed(4)}`;
  ws.send(JSON.stringify({type:'geo', lat:pos.coords.latitude, lon:pos.coords.longitude}));
});
let ctx, analyser, dataArray, mediaRecorder, recording=false;
const canvas = document.getElementById('osc');
const mute = document.getElementById('mute');
const recordBtn = document.getElementById('record');
recordBtn.onclick = async () => {
  if(recording){
    mediaRecorder.stop();
    recordBtn.textContent='Record';
    recording=false;
  } else {
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    ctx = new AudioContext();
    analyser = ctx.createAnalyser();
    const source = ctx.createMediaStreamSource(stream);
    source.connect(analyser);
    analyser.fftSize=2048;
    dataArray = new Uint8Array(analyser.fftSize);
    draw();
    mediaRecorder = new MediaRecorder(stream);
    let chunks=[];
    mediaRecorder.ondataavailable=e=>chunks.push(e.data);
    mediaRecorder.onstop=()=>{
      const blob=new Blob(chunks,{type:'audio/webm'}); chunks=[];
      blob.arrayBuffer().then(buf=>{
        if(!mute.checked){
          const bin=new Uint8Array(buf);
          const b64=btoa(String.fromCharCode(...bin));
          ws.send(JSON.stringify({type:'audio', base64:b64}));
        }
      });
    };
    mediaRecorder.start();
    recordBtn.textContent='Stop';
    recording=true;
  }
};
function draw(){
  if(!recording){return;}
  requestAnimationFrame(draw);
  analyser.getByteTimeDomainData(dataArray);
  const c=canvas.getContext('2d');
  c.clearRect(0,0,canvas.width,canvas.height);
  c.beginPath();
  for(let i=0;i<dataArray.length;i++){
    const v=dataArray[i]/128.0; const y=v*canvas.height/2;
    if(i===0) c.moveTo(i,y); else c.lineTo(i,y);
  }
  c.stroke();
}
</script>
</body>
</html>
