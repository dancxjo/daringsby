<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Pete Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/foundation-sites@6.7.5/dist/css/foundation.min.css">
</head>
<body class="grid-container" style="margin-top:1rem;">
<h1 style="margin-bottom:1rem;">Pete Dashboard</h1>
<div class="grid-x grid-margin-x">
  <div class="cell medium-6">
    <h2>Logs</h2>
    <form id="chat-form" class="input-group" style="margin-bottom:0.5rem;">
      <input id="chat-input" type="text" class="input-group-field" autocomplete="off">
      <div class="input-group-button">
        <button class="button primary" type="submit">Send</button>
      </div>
    </form>
    <pre id="log" class="callout" style="height:300px; overflow:auto;"></pre>
  </div>
  <div class="cell medium-6">
    <h2>Scheduler</h2>
    <div id="sched"></div>
    <h2>Heart</h2>
    <pre id="heart" class="callout" style="height:150px; overflow:auto;"></pre>
  </div>
</div>
<script>
const ws = new WebSocket(`ws://${location.host}/ws`);
const procs = {};
function procDom(name) {
  if(!procs[name]) {
    const det = document.createElement('details');
    det.open = true;
    const summary = document.createElement('summary');
    det.appendChild(summary);
    const prompt = document.createElement('pre');
    prompt.className = 'callout';
    const chunks = document.createElement('pre');
    chunks.className = 'callout';
    det.appendChild(prompt);
    det.appendChild(chunks);
    document.getElementById('sched').appendChild(det);
    procs[name] = {det, summary, prompt, chunks};
  }
  return procs[name];
}

ws.onmessage = ev => {
  const pre = document.getElementById('log');
  pre.textContent = ev.data + '\n' + pre.textContent;
  if(ev.data.startsWith('prompt:')) {
    const rest = ev.data.slice(7);
    const idx = rest.indexOf(':');
    const name = rest.slice(0, idx);
    const prompt = rest.slice(idx + 1);
    const dom = procDom(name);
    dom.prompt.textContent = prompt;
    dom.chunks.textContent = '';
  } else if(ev.data.startsWith('chunk:')) {
    const rest = ev.data.slice(6);
    const idx = rest.indexOf(':');
    const name = rest.slice(0, idx);
    const chunk = rest.slice(idx + 1);
    const dom = procDom(name);
    dom.chunks.textContent += chunk;
  }
};
document.getElementById('chat-form').addEventListener('submit', ev => {
  ev.preventDefault();
  const input = document.getElementById('chat-input');
  const line = input.value;
  if(line.trim() !== '') {
    ws.send(JSON.stringify({type:'chat', line}));
    input.value = '';
  }
});
async function refresh() {
  const psyche = await (await fetch('/psyche')).json();
  const sched = await (await fetch('/scheduler')).json();
  document.getElementById('heart').textContent = JSON.stringify({
    instant: psyche.instant,
    moment: psyche.moment,
    context: psyche.context
  }, null, 2);
  sched.wits.forEach((w, i) => {
    const name = w.name ?? `Processor ${i}`;
    const dom = procDom(name);
    dom.summary.textContent = `${name} (queue: ${w.queue_len})`;
  });
}
refresh();
setInterval(refresh, 1000);
</script>
</body>
</html>
