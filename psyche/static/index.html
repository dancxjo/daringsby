<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Pete Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/foundation-sites@6.7.5/dist/css/foundation.min.css">
</head>
<body class="grid-container" style="margin-top:1rem;">
<h1 style="margin-bottom:1rem;">Pete Dashboard</h1>
<div class="grid-x grid-margin-x">
  <div class="cell medium-6">
    <h2>Logs</h2>
    <form id="chat-form" class="input-group" style="margin-bottom:0.5rem;">
      <input id="chat-input" type="text" class="input-group-field" autocomplete="off">
      <div class="input-group-button">
        <button class="button primary" type="submit">Send</button>
      </div>
    </form>
    <pre id="log" class="callout" style="height:300px; overflow:auto;"></pre>
  </div>
  <div class="cell medium-6">
    <h2>System Info</h2>
    <button id="refresh" class="button secondary" style="margin-bottom:0.5rem;">Refresh</button>
    <pre id="info" class="callout" style="height:150px; overflow:auto;"></pre>
    <h3>Scheduler</h3>
    <table id="sched-table" class="hover" style="font-size:0.9rem;">
      <thead>
        <tr><th>Wit</th><th>Queue</th><th>Next ms</th><th style="width:40%">Progress</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
<script>
const ws = new WebSocket(`ws://${location.host}/ws`);
ws.onmessage = ev => {
  const pre = document.getElementById('log');
  pre.textContent = ev.data + '\n' + pre.textContent;
};
document.getElementById('chat-form').addEventListener('submit', ev => {
  ev.preventDefault();
  const input = document.getElementById('chat-input');
  const line = input.value;
  if(line.trim() !== '') {
    ws.send(JSON.stringify({type:'chat', line}));
    input.value = '';
  }
});
async function refresh() {
  const psyche = await (await fetch('/psyche')).json();
  const sched = await (await fetch('/scheduler')).json();
  document.getElementById('info').textContent = JSON.stringify({psyche, sched}, null, 2);
  const body = document.querySelector('#sched-table tbody');
  body.innerHTML = '';
  sched.wits.forEach((w, i) => {
    const pinfo = psyche.wits[i] || {};
    const pct = pinfo.interval_ms ? Math.min(100, Math.round(100 * (pinfo.interval_ms - w.due_ms) / pinfo.interval_ms)) : 0;
    const row = document.createElement('tr');
    row.innerHTML = `<td>${w.name ?? i}</td><td>${w.queue_len}</td><td>${w.due_ms}</td>` +
      `<td><div class="progress" role="progressbar" aria-valuenow="${pct}" aria-valuemin="0" aria-valuemax="100">` +
      `<div class="progress-meter" style="width:${pct}%"></div></div></td>`;
    body.appendChild(row);
  });
}
document.getElementById('refresh').addEventListener('click', refresh);
refresh();
</script>
</body>
</html>
