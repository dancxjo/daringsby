<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Pete Dashboard</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/foundation-sites@6.7.5/dist/css/foundation.min.css">
<style>
  body { margin:0; }
  #log { list-style:none; padding:0; margin:0; max-height:40vh; overflow:auto; }
  #log li { white-space:pre-wrap; word-break:break-word; }
  #heart { height:25vh; overflow:auto; }
  #wits { max-height:40vh; overflow:auto; }
  details { margin-bottom:0.5rem; }
  .card { margin-bottom:1rem; }
</style>
</head>
<body class="grid-container fluid">
<header class="grid-x align-justify align-middle card primary">
  <div class="cell shrink"><h1 style="margin:0;">Pete Dashboard</h1></div>
  <div class="cell shrink"><span id="beat" class="label success"></span></div>
</header>
<div class="grid-x small-up-1 medium-up-2">
  <div class="cell">
    <div class="card callout primary">
      <h2>Logs</h2>
      <form id="chat-form" class="grid-x">
        <input id="chat-input" class="cell auto" type="text" autocomplete="off">
        <button class="button cell shrink" type="submit">Send</button>
      </form>
      <ul id="log"></ul>
    </div>
  </div>
  <div class="cell">
    <div class="card callout secondary">
      <h2>Wits</h2>
      <div id="wits"></div>
      <h2>Heart</h2>
      <pre id="heart"></pre>
    </div>
  </div>
</div>
<script>
const ws = new WebSocket(`ws://${location.host}/ws`);
const procs = {};
function procDom(name) {
  if(!procs[name]) {
    const det = document.createElement('details');
    det.open = true;
    const summary = document.createElement('summary');
    det.appendChild(summary);
    const prompt = document.createElement('p');
    prompt.className = 'callout primary';
    const chunks = document.createElement('p');
    chunks.className = 'callout secondary';
    prompt.textContent = 'Prompt: ';
    chunks.textContent = 'Response: ';
    det.appendChild(prompt);
    det.appendChild(chunks);
    document.getElementById('wits').appendChild(det);
    procs[name] = {det, summary, prompt, chunks};
  }
  return procs[name];
}

ws.onmessage = ev => {
  const log = document.getElementById('log');
  const li = document.createElement('li');
  li.textContent = ev.data;
  log.prepend(li);
  if(ev.data.startsWith('prompt:')) {
    const rest = ev.data.slice(7);
    const idx = rest.indexOf(':');
    const name = rest.slice(0, idx);
    const prompt = rest.slice(idx + 1);
    const dom = procDom(name);
    dom.prompt.textContent = 'Prompt: ' + prompt;
    dom.chunks.textContent = 'Response: ';
  } else if(ev.data.startsWith('chunk:')) {
    const rest = ev.data.slice(6);
    const idx = rest.indexOf(':');
    const name = rest.slice(0, idx);
    const chunk = rest.slice(idx + 1);
    const dom = procDom(name);
    dom.chunks.textContent += chunk;
  }
};
document.getElementById('chat-form').addEventListener('submit', ev => {
  ev.preventDefault();
  const input = document.getElementById('chat-input');
  const line = input.value;
  if(line.trim() !== '') {
    ws.send(JSON.stringify({type:'chat', line}));
    input.value = '';
  }
});
async function refresh() {
  const psyche = await (await fetch('/psyche')).json();
  const sched = await (await fetch('/scheduler')).json();
  document.getElementById('beat').textContent = `beat ${psyche.beat}`;
  document.getElementById('heart').textContent = JSON.stringify({
    beat: psyche.beat,
    instant: psyche.instant,
    moment: psyche.moment,
    context: psyche.context
  }, null, 2);
  sched.wits.forEach((w, i) => {
    const name = w.name ?? `Processor ${i}`;
    const dom = procDom(name);
    dom.summary.textContent = `${name} (queue: ${w.queue_len}, mem: ${w.memory_len})`;
    if(w.last_prompt){
      dom.prompt.textContent = 'Prompt: ' + w.last_prompt;
    }
  });
}
refresh();
setInterval(refresh, 1000);
</script>
</body>
</html>
