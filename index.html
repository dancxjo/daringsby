<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Pete Console</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.3.0/dist/themes/light.css">
  <style>
    #log { white-space: pre-wrap; }
  </style>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.3.0/dist/shoelace.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="container">
  <div x-data="chatApp()" x-init="init()" class="section">
    <div id="status" x-text="status" class="mb-2 has-text-weight-bold"></div>
    <pre id="log" x-text="log" class="box"></pre>
    <div class="field has-addons">
      <div class="control is-expanded">
        <sl-input class="input" placeholder="Say something..." x-model="input"></sl-input>
      </div>
      <div class="control">
        <sl-button variant="primary" @click.prevent="send">Send</sl-button>
      </div>
    </div>
  </div>
  <script>
    function chatApp() {
      return {
        ws: null,
        status: 'WS: connecting',
        log: '',
        input: '',
        init() { this.connect(); },
        connect() {
          this.status = 'WS: connecting';
          this.ws = new WebSocket('ws://localhost:3000/ws');
          this.ws.onopen = () => this.status = 'WS: open';
          this.ws.onclose = () => { this.status = 'WS: closed'; setTimeout(() => this.connect(), 1000); };
          this.ws.onerror = () => this.status = 'WS: error';
          this.ws.onmessage = (ev) => {
            try {
              const data = JSON.parse(ev.data);
              if (data.text) {
                this.log += data.text;
                this.$nextTick(() => {
                  this.ws.send(JSON.stringify({ type: 'displayed', text: data.text }));
                });
              }
            } catch (_) {
              this.log += ev.data;
            }
          };
        },
        send() {
          if (!this.input) return;
          this.ws.send(JSON.stringify({ type: 'user', message: this.input }));
          this.input = '';
        }
      }
    }
  </script>
</body>
</html>
