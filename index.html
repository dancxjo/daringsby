<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Pete Console</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #log.chat-log { white-space: pre-wrap; max-height: 60vh; overflow-y: auto; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-50 to-slate-100 font-sans text-gray-800">
  <div x-data="chatApp()" x-init="init()" class="w-full max-w-xl p-6 space-y-4 bg-white rounded-xl shadow">
    <div id="status" x-text="status" class="text-xs font-semibold text-gray-500"></div>
    <div id="log" x-ref="log" class="chat-log p-2 bg-gray-50 rounded flex flex-col space-y-1">
      <template x-for="(msg, i) in log" :key="i">
        <div :class="msg.role === 'user' ? 'text-blue-600 text-right' : 'text-left'" x-text="msg.text"></div>
      </template>
    </div>
    <form class="flex gap-2"  @submit.prevent="send">
      <label for="input" class="sr-only">Message</label>
      <input type="text" class="flex-grow border rounded px-3 py-2" placeholder="Say something..." x-model="input" />
      <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Send</button>
    </form>
  </div>
  <script>
    function chatApp() {
      return {
        ws: null,
        status: 'WS: connecting',
        log: [],
        input: '',
        init() { this.connect(); },
        connect() {
          if (this.ws && (this.ws.readyState === WebSocket.OPEN || this.ws.readyState === WebSocket.CONNECTING)) {
            return;
          }
          if (this.ws) { this.ws.close(); }
          this.status = 'WS: connecting';
          this.ws = new WebSocket('ws://localhost:3000/ws');
          this.ws.onopen = () => this.status = 'WS: open';
          this.ws.onclose = () => { this.status = 'WS: closed'; setTimeout(() => this.connect(), 1000); };
          this.ws.onerror = () => this.status = 'WS: error';
          this.ws.onmessage = (ev) => {
            try {
              const data = JSON.parse(ev.data);
              if (data.text) {
                this.append('system', data.text);
              }
            } catch (_) {
              this.append('system', ev.data);
            }
          };
        },
        append(role, text) {
          const el = this.$refs.log;
          const atBottom = el.scrollTop + el.clientHeight >= el.scrollHeight - 2;
          if (role === 'system' && this.log.length && this.log[this.log.length - 1].role === 'system') {
            this.log[this.log.length - 1].text += text;
          } else {
            this.log.push({ role, text });
          }
          this.$nextTick(() => {
            if (atBottom) el.scrollTop = el.scrollHeight;
            if (role !== 'user') this.ws.send(JSON.stringify({ type: 'displayed', text }));
          });
        },
        send() {
          if (!this.input) return;
          this.append('user', this.input);
          this.ws.send(JSON.stringify({ type: 'user', message: this.input }));
          this.input = '';
        }
      }
    }
  </script>
</body>
</html>
