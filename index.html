<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Pete Chat</title>
    <script
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
      defer
    ></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/skeleton-css@2.0.4/css/skeleton.min.css"
    />
  </head>
  <body x-data="chat()">
    <div class="container">
      <h1>Chat with Pete</h1>
      <p id="prompt" class="u-full-width" x-text="prompt"></p>
      <p id="reply" class="u-full-width" x-text="reply"></p>
      <div
        id="log"
        style="height: 15rem; overflow-y: auto"
        class="u-full-width"
      >
        <template x-for="line in lines" :key="line.id">
          <div x-text="line.text"></div>
        </template>
      </div>
      <form @submit.prevent="send">
        <div class="row">
          <div class="six columns">
            <input x-model="name" placeholder="Your name" />
          </div>
          <div class="six columns">
            <input x-model="input" placeholder="Say something" />
          </div>
        </div>
        <button type="submit">Send</button>
      </form>
    </div>
    <script>
      function chat() {
        const state = {
          lines: [],
          prompt: "",
          reply: "",
          name: "",
          input: "",
          send() {
            if (!this.name) {
              alert("Please enter your name");
              return;
            }
            ws.send(
              JSON.stringify({ name: this.name, message: this.input }),
            );
            this.lines.push({
              id: Date.now(),
              text: `${this.name}: ${this.input}`,
            });
            this.input = "";
          },
        };

        const ws = new WebSocket("ws://" + location.host + "/ws");
        ws.onmessage = (e) => {
          try {
            const data = JSON.parse(e.data);
            if (data.type === "pete-prompt") {
              state.prompt = data.text;
              state.reply = "";
            } else if (data.type === "pete-stream") {
              state.reply += data.text;
            } else if (data.type === "pete-says") {
              state.lines.push({
                id: Date.now(),
                text: `Pete: ${data.text}`,
              });
              ws.send(
                JSON.stringify({ type: "echo", message: data.text }),
              );
            }
          } catch (_) {
            // ignore invalid payloads
          }
          const log = document.getElementById("log");
          log.scrollTop = log.scrollHeight;
        };

        return state;
      }
    </script>
  </body>
</html>
