<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Pete Console</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #log.chat-log {
      white-space: pre-wrap;
      overflow-y: auto;
    }
    #log.chat-log li.user {
      align-self: flex-end;
      background-color: #bfdbfe;
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
    }
    #log.chat-log li.system {
      align-self: flex-start;
      background-color: #e5e7eb;
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-50 to-slate-100 font-sans text-gray-800">
  <div x-data="chatApp()" x-init="init()" class="flex w-full max-w-4xl h-[80vh] bg-white rounded-xl shadow overflow-hidden">
    <aside class="w-48 p-4 bg-gray-100 space-y-2">
      <div id="status" x-text="status" class="text-xs font-semibold text-gray-500"></div>
      <div id="face" x-text="emotion" class="text-4xl"></div>
      <audio controls x-ref="player" class="w-full"></audio>
      <video x-ref="video" autoplay playsinline class="w-full max-h-40"></video>
    </aside>
    <main class="flex flex-col flex-1 p-6 space-y-4">
      <ul id="log" x-ref="log" class="chat-log p-2 bg-gray-50 rounded flex flex-col space-y-1 flex-grow list-none">
        <template x-for="(msg, i) in log" :key="i">
          <li :class="msg.role" x-text="msg.text"></li>
        </template>
      </ul>
      <form class="flex gap-2 mt-auto" @submit.prevent="send">
        <label for="input" class="sr-only">Message</label>
        <input type="text" autofocus class="flex-grow border rounded px-3 py-2" placeholder="Say something..." x-model="input" />
        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Send</button>
        <button type="button" @click.prevent="capture" class="px-3 py-2 bg-gray-300 rounded">Snap</button>
      </form>
    </main>
  </div>
  <script>
    function chatApp() {
      return {
        ws: null,
        status: 'WS: connecting',
        log: [],
        input: '',
        lastText: '',
        emotion: '😐',
        audioQueue: [],
        playing: false,
        stream: null,
        init() { this.connect(); this.initCamera(); },
        initCamera() {
          navigator.mediaDevices.getUserMedia({ video: true }).then(s => {
            this.stream = s;
            const v = this.$refs.video;
            v.srcObject = s;
            v.play();
          }).catch(() => {});
        },
        connect() {
          if (this.ws && (this.ws.readyState === WebSocket.OPEN || this.ws.readyState === WebSocket.CONNECTING)) {
            return;
          }
          if (this.ws) { this.ws.close(); }
          this.status = 'WS: connecting';
          this.ws = new WebSocket('ws://localhost:3000/ws');
          this.ws.onopen = () => this.status = 'WS: open';
          this.ws.onclose = () => { this.status = 'WS: closed'; setTimeout(() => this.connect(), 1000); };
          this.ws.onerror = () => this.status = 'WS: error';
          this.ws.onmessage = (ev) => {
            try {
              const data = JSON.parse(ev.data);
              if (data.kind === 'pete-emotion') {
                this.emotion = data.text;
              } else if (data.text) {
                this.lastText = data.text;
                this.append('system', data.text);
              }
              if (data.audio) {
                this.audioQueue.push({ audio: data.audio, text: this.lastText });
                console.log('queued audio', this.audioQueue.length);
                this.playNext();
              }
            } catch (_) {
              this.append('system', ev.data);
            }
          };
        },
        playNext() {
          if (this.playing || this.audioQueue.length === 0) return;
          const { audio, text } = this.audioQueue.shift();
          const player = this.$refs.player;
          let mime = 'audio/wav';
          const tryPlay = () => {
            player.src = `data:${mime};base64,${audio}`;
            const attempt = player.play();
            if (attempt !== undefined) {
              attempt.catch(err => {
                if (err.name === 'NotSupportedError' && mime === 'audio/wav') {
                  mime = 'audio/mpeg';
                  tryPlay();
                } else if (err.name === 'NotAllowedError') {
                  const resume = () => {
                    document.removeEventListener('click', resume);
                    tryPlay();
                  };
                  document.addEventListener('click', resume);
                } else {
                  console.error('Audio playback failed:', err);
                }
              });
            }
          };
          player.onended = () => {
            this.playing = false;
            this.ws.send(JSON.stringify({ type: 'played', text }));
            console.log('sent played ack:', text);
            this.playNext();
          };
          this.playing = true;
          tryPlay();
        },
        append(role, text) {
          const el = this.$refs.log;
          const atBottom = el.scrollTop + el.clientHeight >= el.scrollHeight - 2;
          if (this.log.length && this.log[this.log.length - 1].role === role) {
            this.log[this.log.length - 1].text += text;
          } else {
            this.log.push({ role, text });
          }
          this.$nextTick(() => {
            if (atBottom) el.scrollTop = el.scrollHeight;
            if (role !== 'user') {
              this.ws.send(JSON.stringify({ type: 'displayed', text }));
              console.log('sent displayed ack:', text);
            }
          });
        },
        send() {
          if (!this.input) return;
          this.append('user', this.input);
          this.ws.send(JSON.stringify({ type: 'user', message: this.input }));
          this.input = '';
        },
        capture() {
          const v = this.$refs.video;
          const c = document.createElement('canvas');
          c.width = v.videoWidth;
          c.height = v.videoHeight;
          c.getContext('2d').drawImage(v, 0, 0);
          const base64 = c.toDataURL('image/png').split(',')[1];
          this.ws.send(JSON.stringify({ type: 'image', mime: 'image/png', base64 }));
        }
      }
    }
  </script>
</body>
</html>
