<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Pete Chat</title>
    <script
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
      defer
    ></script>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.4/dist/tailwind.min.css"
      rel="stylesheet"
    >
  </head>
  <body class="bg-gray-50" x-data="chat()">
    <div class="max-w-lg mx-auto p-4">
      <h1 class="text-2xl mb-4 text-center">Chat with Pete</h1>
      <div class="border h-64 overflow-y-auto p-2 mb-4 bg-white" id="log">
        <template x-for="line in lines" :key="line.id">
          <div class="mb-1" x-text="line.text"></div>
        </template>
      </div>
      <form @submit.prevent="send" class="flex gap-2">
        <input x-model="name" class="border p-2 w-32" placeholder="Your name" />
        <input
          x-model="input"
          autofocus
          class="border p-2 flex-grow"
          placeholder="Say something"
        />
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">
          Send
        </button>
      </form>
    </div>
    <script>
      function chat() {
        const ws = new WebSocket("ws://" + location.host + "/ws");
        ws.onmessage = (e) => {
          try {
            const data = JSON.parse(e.data);
            if (data.type === "pete-says") {
              this.lines.push({ id: Date.now(), text: `Pete: ${data.text}` });
              ws.send(JSON.stringify({ type: "echo", message: data.text }));
            }
          } catch (_) {
            // ignore invalid payloads
          }
          const log = document.getElementById("log");
          log.scrollTop = log.scrollHeight;
        };
        return {
          lines: [],
          name: "",
          input: "",
          send() {
            if (!this.name) {
              alert("Please enter your name");
              return;
            }
            ws.send(
              JSON.stringify({ name: this.name, message: this.input }),
            );
            this.lines.push({
              id: Date.now(),
              text: `${this.name}: ${this.input}`,
            });
            this.input = "";
          },
        };
      }
    </script>
  </body>
</html>
